title: 从零开始搭建 Express + Vue 生产环境
tags: express, vue, webpack, node
---

上一篇文章介绍了如何从零开始搭建 Express + Vue 的开发环境，现在介绍一下如何搭建生产环境。

## 前端：压缩、混淆、分离css

与开发环境相比，部署在生产环境中的代码需要经过压缩，去除注释、去除多余的空格换行，去除 source map，等等。可别小看了压缩代码这个步骤，也许 webpack 在开发环境中打包产生的代码超过了 10Mb，但经过压缩以后只有不到 1Mb。需要注意的是，不光是 javascript，像是 html，css 也都可以压缩。

另一个比较重要的步骤是代码混淆，这是前端特有的步骤。因为前端的 javascript、html、css 是完全暴露给用户的，基本没有安全性可言。经过代码混淆以后，可以很有效地增加破解前端的困难，杜绝大部分不怀好意的企图。

最后是分离css文件。在开发的时候，我们是将所有资源文件都打包成一个 js 文件一并加载的，这样便于开发调试（hot-reload）。但是在生产环境中，我们需要将其分离成单独的文件。这是因为 css 文件普遍没有 javascript 文件巨大，但是却控制了整个页面的外表，对用户体验至关重要，如果合并在 js 代码中会导致页面加载速度慢。所以应该单独分离出去放在 html 文档顶部让浏览器优先加载。

## 后端：ES5转码，编译依赖模块，分离配置

Node 的运行环境仍然是基于 ES5 的，在开发环境中，为了便于调试我们采用的是 babel 动态转码的方式（require register）。但是在生产环境中，仍然推荐先把 ES6 代码转码成 ES5 再运行。好处就是在 production server 上不需要再安装 babel 了，你肯定不想折腾 production server 上的 babel 版本。所以，首先我们要使用 babel 工具将所有源文件编译成 ES5 语法。

编译依赖模块，这个比较好理解，就是将 node_modules 中用到的依赖都按照 production 模式编译一下，主要是可以降低依赖模块的文件体积，便于部署到服务器上，有些模块甚至还会在性能上有些提升。

整理各种配置项，比如数据库名、用户名、端口等等，并将他们按照开发环境和生产环境分离开，做到让程序根据 NODE_ENV 去加载正确的配置。另外，建议将配置项以环境变量的形式引入，而不是保存在文件里。这主要是出于安全考虑，因为把密码、端口这些敏感信息明文保存在文件中实在不是一件明智的举动。

最后，后端没有必要混淆代码。
